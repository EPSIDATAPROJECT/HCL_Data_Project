  <!DOCTYPE html>


<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />

  <title>OVR : Outil de visualisation Remera</title>
  
  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="stylesheets/foundation.min.css">
  <link rel="stylesheet" href="stylesheets/app.css">
  <link rel="stylesheet" href="stylesheets/multi-select.css">
  <link rel="stylesheet" href="stylesheets/introjs.css">

  <script src="javascripts/modernizr.foundation.js"></script>
</head>
<body>

  <div class="banner">
    <div class="row">
        <div class="four columns centered">
        <img src="images/logo-remera.png"></div>
    </div>
    <div class="row centered">
      <div class="nine columns centered">
        <h1 id="data-step-1">Visualisation graphique</h1>
      </div>
    </div>
  </div>

  
	<a class="home_button radius button" href="index.html">Retour vers la page d'accueil</a>


  <div id="chart_content">
    <div class="row">
      <div id="chart_container" class="eight columns" >
        <center>
          <img src="images/Flaticon_1045.svg" width="400px" alt="Graphique">
          </center>
      </div>
      <div class="four columns">


<ul id="data-step-2" class="accordion">
  <li class="active">
    <div class="title">
      <h5 id="data-step-3">Malformations</h5>
      <div id="malformation_tag"></div>
    </div>
    <div id="malformation_content" class="content">
      <input type="text" id="search_malformation" class="accordion_content_search" placeholder="Rechercher">

      
      <div id="data-step-5" class="accordion_content_checkbox">
        <label for="Y74"><input type="radio" name="radio_malformations" id="Y74" class="radio">Foetus oligoasmnios</label>
        <label for="Y75"><input type="radio" name="radio_malformations" id="Y75" class="radio">Hydramnios</label>
        <label for="Y76"><input type="radio" name="radio_malformations" id="Y76" class="radio">Syndrôme de transfusion</label>

        <label for="Y77"><input type="radio" name="radio_malformations" id="Y77" class="radio">Croissance lente du foetus</label>
        <label for="Y79"><input type="radio" name="radio_malformations" id="Y79" class="radio">Syndrôme de détresse respiratoire</label>
        <label for="Y83"><input type="radio" name="radio_malformations" id="Y83" class="radio">Dysplasie broncho-pulmonaire</label>
        <label for="Y84"><input type="radio" name="radio_malformations" id="Y84" class="radio">Hypertension néonatale</label>
        <label for="Y86"><input type="radio" name="radio_malformations" id="Y86" class="radio">Affections cardiovasculaire (périnatale)</label>
        <label for="Y90"><input type="radio" name="radio_malformations" id="Y90" class="radio">Toxoplasmose</label>
        <label for="Y97"><input type="radio" name="radio_malformations" id="Y97" class="radio">Anasarque foetoplacentaire</label>
        <label for="Y98"><input type="radio" name="radio_malformations" id="Y98" class="radio">Hydrosele congénitale</label>
        <label for="Y102"><input type="radio" name="radio_malformations" id="Y102" class="radio">Hypotonie congénitale</label>
      </div>
    </div>
  </li>

  <li>
    <div class="title">
      <h5>Descripteur globaux</h5>
      <div id="traitement_mere_tag"></div>
    </div>
    <div id="traitement_mere_content" class="content">
      <input type="text" id="search_traitement_mere" class="accordion_content_search" placeholder="Rechercher">

      
      <div class="accordion_content_checkbox">
        <label for="C86_4"><input type="checkbox" id ="C84_4" class="checkbox">Trisomies</label>
        <label for="C86_5"><input type="checkbox" id ="C86_5" class="checkbox">Trisomies partielles</label>
        <label for="C86_6"><input type="checkbox" id ="C86_6" class="checkbox">Monosomies</label>
        <label for="C86_7"><input type="checkbox" id ="C86_7" class="checkbox">Klinefelter</label>
        <label for="C86_8"><input type="checkbox" id ="C86_8" class="checkbox">Triploïdie</label>
        <label for="C86_9"><input type="checkbox" id ="C86_9" class="checkbox">X fragile</label>
        <label for="C86_10"><input type="checkbox" id ="C86_10" class="checkbox">Triple X</label>
        <label for="C86_11"><input type="checkbox" id ="C86_11" class="checkbox">Disomie du Y</label>
        <label for="C86_12"><input type="checkbox" id ="C86_12" class="checkbox">Deletion</label>
      </div>
    </div>
  </li>
</ul>
    <label>Fonctions</label>
    <label for="C3_2"><input type="checkbox" id ="C3_2" class="resultBy">Résulat en fonction du temps (Beta)</label>

    <label>Fonctions</label>

      <label for="SUM"><input name="radio_fonction" type="radio" class="aggregation" id="SUM">Nombre d'occurence</label>
      <label for="AVG"><input name="radio_fonction" CHECKED type="radio" class="aggregation" id="AVG">Moyenne</label>




<label>Type de diagramme</label>
        <label for="pie"><input type="radio" name="radio_chartstyle" class="chart_style" id="pie">Circulaire</label>
        <label for="line"><input type="radio" name="radio_chartstyle" class="chart_style" id="line">Ligne</label>
        <label for="bar"><input type="radio" name="radio_chartstyle" class="chart_style" id="bar">Barre</label>
        <label for="area"><input type="radio" name="radio_chartstyle" class="chart_style" id="area">Aire</label>




        <a id="data-step-6"class="radius button" onclick="process_chart();">Générer graphique</a>
        <a class="radius button" onclick="process_table();">Voir sous forme de table</a>





      </div>
      
    </div>
  </div>


  <!-- Included JS Files (Compressed) -->
  <script src="javascripts/jquery.js"></script>
  <script src="javascripts/foundation.min.js"></script>
  <script src="javascripts/jquery.multi-select.js"></script>
  <script src="javascripts/jquery.quicksearch.js"></script>
  <script src="javascripts/highcharts.js"></script>
  <script src="javascripts/intro.min.js"></script>
  <!-- Initialize JS Plugins -->
  <script src="javascripts/app.js"></script>
  <script type="text/javascript">
 // Decoche les options lors d'un raffraichissement de la page    
$('input:checked[type=checkbox]').attr('checked', false);
$('.accordion_content_search').val('');


// Change le type de graphique
$('input[name=radio_chartstyle]').bind('change', function() {
    if (typeof $('#chart_container').highcharts() !== "undefined") {
      $('#chart_container').empty();
      $('#chart_container').highcharts().series[0].update({ type: $('input:checked[name=radio_chartstyle]').attr('id')});
    }
});


$(window).bind('beforeunload', function() {
    var nb_check =  $('input:checked[type=checkbox]').length; 
    if (nb_check > 0) {
      return 'Are you really sure ?';
    }
});


// sum, moyenne, 
// creation de la requete pour envoyer au script php
// structure de la requete {col: }
var process_chart = function (params) {
 if (!params) {
  var nb_check =  $('input.checkbox:checked').length;
  var nb_agg = $('input.aggregation:checked').length;

  var parametre = '{';
  parametre += '"valeurs" : [';
  $('input.checkbox:checked').each(function() {

      if(nb_check === 1) {
        parametre += '{"'+$(this)[0].id+'":""}';
      } else {
        parametre += '{"'+$(this)[0].id+'":""},';
      }
      nb_check--;
    });
  parametre += '], "agg" : [';

  $('input.aggregation:checked').each(function() {
    if(nb_agg === 1) {
        parametre += '{"'+$(this)[0].id+'":""}';
      } else {
        parametre += '{"'+$(this)[0].id+'":""},';
      }
      nb_agg--;
  });


  parametre += ']';


  if ($('input.resultBy:checked').attr('id'))
  parametre += ',"resultBy" : "' + $('input.resultBy:checked').attr('id')+'"';



    parametre+='}';  
    var params = $.parseJSON(parametre);
    console.log(params);
 }
var categories = [];
$.ajax({
        url: 'request_csv.php',
        type:'POST',
        data: {
             fonction:'request',
             params: params,
        },
        success: function(data)
        {
          var data_json = $.parseJSON(data);
console.log(data_json);
           var donnee = [];
           var categories = [];
           var valeur = 0;


           ////
           if (!$('input.resultBy:checked').attr('id')) {
              $.each(data_json, function (key, value){
                
                if (value.SUM > 0)
                  valeur = value.SUM
                else if (value.AVG > 0)
                  valeur = value.AVG

   
                  var name = $('label[for='+key+']')[0].textContent;
                  donnee.push({name: name, y: valeur});
                  categories.push(name);

              });
              donnee.sort(sortByValue);

               $('#chart_container').highcharts({
                chart: {
                    type: $('input:checked[name=radio_chartstyle]').attr('id')
                },
                title: {
                    text: 'Malformations'
                },
                xAxis: {
                    categories: categories
                },
                yAxis: {
                    title: {
                        text: ''
                    }
                },
                series: [{
                  name: 'Browser share',
                  data: donnee
                }]
            });

            } else {


            var colors = Highcharts.getOptions().colors;
            // on met les années dans en catégorie
            
            var data = [];
            var sum = 0;
            $.each(data_json, function (annee, obj_key){
              sum = 0;
              
              $.each(obj_key, function (key, value) {
                if (value.AVG > 0) {
                  sum += value.AVG;
                  data.push({name: annee, categories: key, data:value.AVG});
                } else if (value.SUM > 0) {
                  sum += value.SUM;
                  data.push({name: annee, categories: key, data:value.SUM});
                }
              });


              categories.push({name: annee, y: sum});
            });
    
        var niveau0 = [];
        var niveau1 = [];

        var sum = 0;


   for (var i = 0; i < categories.length; i++) {
            // add browser data
            niveau0.push({
                name: categories[i].name,
                y: categories[i].y,
                color: colors[i]
            });
    
            // add version data
            for (var j = 0; j < data.length; j++) {
                //var brightness = 0.2 - (j / data[i].data.length) / 5 ;
                if (data[j].name === categories[i].name) {
                niveau1.push({
                    name: data[j].categories,
                    y: data[j].data,
                    color: colors[i]
                    //color: Highcharts.Color(data[i].color).brighten(brightness).get()
                });
              }
            }
        }


                $('#chart_container').highcharts({
                chart: {
                    type: $('input:checked[name=radio_chartstyle]').attr('id')
                },
                title: {
                    text: 'Malformations'
                },
                xAxis: {
                    categories: categories
                },
                yAxis: {
                    title: {
                        text: ''
                    }
                },
                series: [{
                  name: 'Annee',
                  data: niveau0,
                   size: '60%',
                }, {
                  name: 'Malformations',
                  data: niveau1,
                   size: '80%',
                  innerSize: '60%',
                  dataLabels: {
                    formatter: function() {
                        // display only if larger than 1
                        return this.y > 1 ? '<b>'+ this.point.name +':</b> '+ this.y +'%'  : null;
                    }
                }
                }]
            });
            }


        }
    });

}


var process_table = function () {
var nb_check =  $('input.checkbox:checked').length;
  var nb_agg = $('input.aggregation:checked').length;

  var parametre = '{';
  parametre += '"valeurs" : [';
  $('input.checkbox:checked').each(function() {

      if(nb_check === 1) {
        parametre += '{"'+$(this)[0].id+'":""}';
      } else {
        parametre += '{"'+$(this)[0].id+'":""},';
      }
      nb_check--;
    });
  parametre += '], "agg" : [';

  $('input.aggregation:checked').each(function() {
    if(nb_agg === 1) {
        parametre += '{"'+$(this)[0].id+'":""}';
      } else {
        parametre += '{"'+$(this)[0].id+'":""},';
      }
      nb_agg--;
  });


  parametre += ']';


    parametre+='}';  
    var params = $.parseJSON(parametre);
 location.href = 'table.html?query=' + JSON.stringify(params);

};

// fonction de tri pour afficher les valeurs dans l'ordre croissant
function sortByValue(a,b) {
   var x = a.y;
    var y = b.y;
    return ((x > y) ? -1 : ((x < y) ? 1 : 0));
}


//fonctions qui écoute le changement des checkbox
//Pour celles qui sont cochés, les rajoutes comme tag dans le titre du volet de l'accordeon
$('#malformation_content').find('input[type=checkbox]').bind('change',function(){

    var labels = $('#malformation_content').find('label');
    var tags = [];

    $.each(labels, function (key, label){
        if(label.childNodes[0].checked)
            tags.push(label.textContent);
    });

    $('.accordion').find('#malformation_tag').empty();
    $.each(tags, function (key, label) {
        $('.accordion').find('#malformation_tag').append('<span class="label">'+label+'</span> ');  
    });
  
});

$('#traitement_mere_content').find('input[type=checkbox]').bind('change',function(){

    var labels = $('#traitement_mere_content').find('label');
    var tags = [];

    $.each(labels, function (key, label){
        if(label.childNodes[0].checked)
            tags.push(label.textContent);
    });

    $('.accordion').find('#traitement_mere_tag').empty();
    $.each(tags, function (key, label) {
        $('.accordion').find('#traitement_mere_tag').append('<span class="label">'+label+'</span> ');  
    });
  
});


// Fonction qui écoute les touches dans la recherche (dans le contenu de l'accordeon)
// Rend visible les label contenant ce qu'il y a dans la recherche
// Si il y a un seul résultat, l'appuie sur entré le sélectionne / déselectionne
$('#search_malformation').bind('keyup',function(e) {
  searchOptions('#malformation_content', $(this).val());

   var code = e.keyCode || e.which;
   if(code == 13) { //Enter keycode
     select_only_one('#malformation_content')
   }
});

$('#search_traitement_mere').bind('keyup',function(e) {
  searchOptions('#traitement_mere_content', $(this).val());

   var code = e.keyCode || e.which;
   if(code == 13) { //Enter keycode
     select_only_one('#traitement_mere_content')
   }
});

// Fonction rendant visible ou non les labels en fonction de la recherche
// idVolet = correspond a l'id du volet de l'accordeon
function searchOptions(idVolet, text) {
 var labels = $(idVolet).find('label');
 var reg = new RegExp(text,"gi");
  
 $.each(labels, function (key, label){

    if (label.textContent.match(reg))
      $(this).show();
    else 
      $(this).hide();
      
  });

}

// Permet de selectionner le seul résultat restant en appuyant sur la touche entrée dans la recherche
function select_only_one(idAccordeon) {
  var labels = $(idAccordeon).find('input:visible[type=checkbox]');

  if (labels.length === 1) {
      if (labels.prop('checked'))
        labels.prop('checked', false);
      else 
        labels.prop('checked', true);
  }


  //$('#malformation_content').find('input[type=checkbox]').trigger('change');
  $(idAccordeon).find('input[type=checkbox]').trigger('change');

}

// fonction permettant d'afficher les données à partir d'une requete d'une autre page
if (RegExp('query', 'gi').test(window.location.search)) {

  //récupérer les paramètres
  var regex = new RegExp("[\\?&]query=([^&#]*)"),
      results = regex.exec(location.search),
      query = decodeURIComponent(results[1].replace(/\+/g, " ")),
      json = $.parseJSON(query);

    // Checker les checkbox
    $.each(json['valeurs'], function(key , obj) {
      $.each(obj, function(key , value) {
        $('input#' + key + '[type=checkbox]').prop('checked', 'checked');
        // trigger pour appeler l'event change sur les checkbox
        $('input#' + key + '[type=checkbox]').trigger('change');
      })
    });

    $.each(json['agg'][0], function(key, obj) {
      $('#' + key).prop('checked', 'checked');
    });
    


    // Création requete
    process_chart($.parseJSON(query));
}
          if (RegExp('multipage', 'gi').test(window.location.search)) {
      var intro = introJs();
        intro.setOptions({
        showStepNumbers : false,
        showBullets : false,
        steps : [
              {
                element: '#data-step-1',
                intro: "Titre de la fen&ecircctre repr&eacutesentation Graphique.",
              },
              {
                element: '#data-step-2',
                intro: "Zone de selection des informations a afficher.",
                position : 'left'
              },
              {
                element: '#data-step-3',
                intro: "Nom des cat&eacute;gories a afficher.",
                position : 'left'
              },
              {
                element: '#search_malformation',
                intro: "Saisissez le nom du champ recherche pour filtrer les informations disponible. <br> S'il n'en reste qu'un seul champ vous pouvez le selectionner directement en appuyant sur Entree",
                position : 'left'
              },
              {
                element: '#data-step-5',
                intro: "Selectionner ici les champs que vous souhaitez afficher.",
                position : 'left'
              },
              {
                element: '#data-step-6',
                intro: "Cliquez ici pour visualiser les donnees selectionnees.",
                position : 'left'
              },
              {
                element: '#chart_container',
                intro: "Vous pouvez passer la sourie sur les elements graphiques pour visualiser le detail des resultats.",
                position : 'left'
              }
              ]});
            intro.start().oncomplete(function() {
              window.location.href = 'index.html?multipage_end=true';
            });
    }
  </script>

  
</body>
</html>
